{% extends 'base.html' %}

{% block title %}{{ title }} - mAgent CRM{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'customers:custom_field_list' %}">Custom Fields</a></li>
                {% if custom_field %}
                <li class="breadcrumb-item active">Edit {{ custom_field.label }}</li>
                {% else %}
                <li class="breadcrumb-item active">Add Custom Field</li>
                {% endif %}
            </ol>
        </nav>
        <h1 class="h3 mb-0">{{ title }}</h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-plus-square"></i> Custom Field Details
                </h5>
            </div>
            <div class="card-body">
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    Field Name <span class="text-danger">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.name.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Internal name (lowercase, no spaces)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.label.id_for_label }}" class="form-label">
                                    Display Label <span class="text-danger">*</span>
                                </label>
                                {{ form.label }}
                                {% if form.label.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.label.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">User-friendly name shown to users</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.field_type.id_for_label }}" class="form-label">
                            Field Type <span class="text-danger">*</span>
                        </label>
                        {{ form.field_type }}
                        {% if form.field_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.field_type.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">Choose the appropriate input type</div>
                    </div>

                    <div class="mb-3" id="options-field" style="display: none;">
                        <label for="{{ form.options.id_for_label }}" class="form-label">
                            Options
                        </label>
                        {{ form.options }}
                        {% if form.options.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.options.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">For dropdown fields, enter options separated by commas</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.is_required }}
                                    <label class="form-check-label" for="{{ form.is_required.id_for_label }}">
                                        Required Field
                                    </label>
                                </div>
                                <div class="form-text">Users must fill this field</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    {{ form.is_active }}
                                    <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                        Active Field
                                    </label>
                                </div>
                                <div class="form-text">Show this field to users</div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{% url 'customers:custom_field_list' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left"></i> Cancel
                            </a>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check2"></i> 
                                {% if custom_field %}Update Field{% else %}Create Field{% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar with help -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-info-circle"></i> Field Types
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-primary">Text</h6>
                    <p class="small text-muted">Single line text input</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary">Long Text</h6>
                    <p class="small text-muted">Multi-line text area</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary">Number</h6>
                    <p class="small text-muted">Numeric input only</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary">Email</h6>
                    <p class="small text-muted">Email validation</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary">Date</h6>
                    <p class="small text-muted">Date picker</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary">Yes/No</h6>
                    <p class="small text-muted">Checkbox input</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-primary">Dropdown</h6>
                    <p class="small text-muted">Select from predefined options</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fieldTypeSelect = document.querySelector('#{{ form.field_type.id_for_label }}');
    const optionsField = document.getElementById('options-field');
    
    function toggleOptionsField() {
        if (fieldTypeSelect.value === 'select') {
            optionsField.style.display = 'block';
        } else {
            optionsField.style.display = 'none';
        }
    }
    
    if (fieldTypeSelect) {
        fieldTypeSelect.addEventListener('change', toggleOptionsField);
        toggleOptionsField(); // Initial check
    }
    
    // Auto-generate field name from label
    const labelInput = document.querySelector('#{{ form.label.id_for_label }}');
    const nameInput = document.querySelector('#{{ form.name.id_for_label }}');
    
    if (labelInput && nameInput && !nameInput.value) {
        labelInput.addEventListener('input', function() {
            const label = this.value.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '_')
                .trim();
            nameInput.value = label;
        });
    }
});
</script>
{% endblock %}