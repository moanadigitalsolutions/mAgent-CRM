{% extends "base.html" %}
{% load static %}

{% block title %}Email Sequences - Analytics{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/analytics.css' %}">
<style>
.sequence-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.sequence-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.sequence-steps {
    max-height: 200px;
    overflow-y: auto;
}

.step-item {
    border-left: 3px solid #dee2e6;
    padding-left: 1rem;
    margin-bottom: 1rem;
    position: relative;
}

.step-item::before {
    content: attr(data-step);
    position: absolute;
    left: -8px;
    top: 0;
    width: 16px;
    height: 16px;
    background: #6c757d;
    color: white;
    border-radius: 50%;
    font-size: 10px;
    line-height: 16px;
    text-align: center;
}

.step-item.active::before {
    background: #198754;
}

.trigger-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.sequence-actions {
    gap: 0.5rem;
}

.sequence-builder {
    min-height: 400px;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
}

.step-builder-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
    position: relative;
}

.step-delay {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

.connector {
    text-align: center;
    color: #6c757d;
    margin: 0.5rem 0;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Email Sequences</h1>
                    <p class="text-muted mb-0">Automated email sequences for customer engagement</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="cloneSequence()">
                        <i class="fas fa-copy"></i> Clone Sequence
                    </button>
                    <button class="btn btn-primary" onclick="createSequence()">
                        <i class="fas fa-plus"></i> New Sequence
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sequences Grid -->
    <div class="row">
        {% for sequence in sequences %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card sequence-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">{{ sequence.name }}</h6>
                    <div class="d-flex align-items-center gap-2">
                        {% if sequence.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                        <span class="badge bg-primary trigger-badge">
                            {{ sequence.get_trigger_type_display }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    {% if sequence.description %}
                        <p class="text-muted small mb-3">{{ sequence.description|truncatechars:100 }}</p>
                    {% endif %}
                    
                    <div class="sequence-steps">
                        <h6 class="small text-muted mb-2">Sequence Steps:</h6>
                        {% for step in sequence.steps.all %}
                            <div class="step-item {% if step.step_number == 1 %}active{% endif %}" 
                                 data-step="{{ step.step_number }}">
                                <div class="fw-bold">{{ step.template.name }}</div>
                                <div class="small text-muted">{{ step.template.subject|truncatechars:40 }}</div>
                                {% if step.delay_days > 0 or step.delay_hours > 0 %}
                                    <div class="step-delay">
                                        <i class="fas fa-clock"></i>
                                        Wait: 
                                        {% if step.delay_days > 0 %}{{ step.delay_days }} day{{ step.delay_days|pluralize }}{% endif %}
                                        {% if step.delay_hours > 0 %}{{ step.delay_hours }} hour{{ step.delay_hours|pluralize }}{% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% empty %}
                            <div class="text-muted small">No steps configured</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Created {{ sequence.created_at|date:"M d, Y" }}
                        </small>
                        <div class="d-flex sequence-actions">
                            <button class="btn btn-sm btn-outline-info" 
                                    onclick="viewSequenceStats({{ sequence.id }})"
                                    title="View Statistics">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" 
                                    onclick="editSequence({{ sequence.id }})"
                                    title="Edit Sequence">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    onclick="testSequence({{ sequence.id }})"
                                    title="Test Sequence">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="deleteSequence({{ sequence.id }})"
                                    title="Delete Sequence">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-sitemap fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Email Sequences</h4>
                <p class="text-muted">Create your first email sequence to automate customer communications.</p>
                <button class="btn btn-primary" onclick="createSequence()">
                    <i class="fas fa-plus"></i> Create Sequence
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="row">
        <div class="col-12">
            <nav aria-label="Sequences pagination">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Sequence Creation/Edit Modal -->
<div class="modal fade" id="sequenceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sequenceModalLabel">Create Email Sequence</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="sequenceForm">
                <div class="modal-body">
                    <div class="row">
                        <!-- Sequence Details -->
                        <div class="col-md-4">
                            <h6 class="fw-bold mb-3">Sequence Details</h6>
                            
                            <div class="mb-3">
                                <label for="sequenceName" class="form-label">Sequence Name</label>
                                <input type="text" class="form-control" id="sequenceName" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="sequenceDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="sequenceDescription" rows="3"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="sequenceTrigger" class="form-label">Trigger Type</label>
                                <select class="form-select" id="sequenceTrigger" required>
                                    <option value="">Select trigger...</option>
                                    <option value="customer_created">New Customer Created</option>
                                    <option value="note_added">Note Added</option>
                                    <option value="file_uploaded">File Uploaded</option>
                                    <option value="manual">Manual Trigger</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sequenceActive" checked>
                                    <label class="form-check-label" for="sequenceActive">
                                        Active Sequence
                                    </label>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button type="button" class="btn btn-outline-primary" onclick="addSequenceStep()">
                                    <i class="fas fa-plus"></i> Add Step
                                </button>
                            </div>
                        </div>
                        
                        <!-- Sequence Builder -->
                        <div class="col-md-8">
                            <h6 class="fw-bold mb-3">Sequence Builder</h6>
                            <div id="sequenceBuilder" class="sequence-builder">
                                <i class="fas fa-plus-circle fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Build Your Email Sequence</h5>
                                <p class="text-muted">Add email steps to create an automated sequence</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" onclick="previewSequence()">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Sequence
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Step Configuration Modal -->
<div class="modal fade" id="stepModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Email Step</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="stepForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="stepTemplate" class="form-label">Email Template</label>
                        <select class="form-select" id="stepTemplate" required>
                            <option value="">Select template...</option>
                            <!-- Templates will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stepDelayDays" class="form-label">Delay (Days)</label>
                                <input type="number" class="form-control" id="stepDelayDays" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stepDelayHours" class="form-label">Delay (Hours)</label>
                                <input type="number" class="form-control" id="stepDelayHours" min="0" max="23" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle"></i>
                            This step will be sent after the specified delay from the previous step.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Step</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sequence Statistics Modal -->
<div class="modal fade" id="statsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sequence Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-primary">156</h4>
                                <small class="text-muted">Total Sent</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-success">89</h4>
                                <small class="text-muted">Delivered</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-info">42</h4>
                                <small class="text-muted">Opened</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-warning">18</h4>
                                <small class="text-muted">Clicked</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <canvas id="sequenceStatsChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentSequenceId = null;
let sequenceSteps = [];
let stepCounter = 0;

function createSequence() {
    currentSequenceId = null;
    sequenceSteps = [];
    stepCounter = 0;
    document.getElementById('sequenceModalLabel').textContent = 'Create Email Sequence';
    document.getElementById('sequenceForm').reset();
    document.getElementById('sequenceBuilder').innerHTML = `
        <i class="fas fa-plus-circle fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Build Your Email Sequence</h5>
        <p class="text-muted">Add email steps to create an automated sequence</p>
    `;
    const modal = new bootstrap.Modal(document.getElementById('sequenceModal'));
    modal.show();
}

function editSequence(sequenceId) {
    currentSequenceId = sequenceId;
    document.getElementById('sequenceModalLabel').textContent = 'Edit Email Sequence';
    
    // In a real app, fetch sequence data via API
    const modal = new bootstrap.Modal(document.getElementById('sequenceModal'));
    modal.show();
}

function deleteSequence(sequenceId) {
    if (confirm('Are you sure you want to delete this sequence?')) {
        alert('Sequence deleted successfully!');
        location.reload();
    }
}

function cloneSequence() {
    alert('Clone sequence functionality would be implemented here.');
}

function testSequence(sequenceId) {
    alert('Test sequence functionality would be implemented here.');
}

function viewSequenceStats(sequenceId) {
    // Show demo stats
    const modal = new bootstrap.Modal(document.getElementById('statsModal'));
    modal.show();
    
    // Create demo chart
    setTimeout(() => {
        const ctx = document.getElementById('sequenceStatsChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Emails Sent',
                    data: [12, 19, 15, 25],
                    borderColor: '#198754',
                    tension: 0.1
                }, {
                    label: 'Emails Opened',
                    data: [8, 12, 9, 15],
                    borderColor: '#0dcaf0',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Sequence Performance Over Time'
                    }
                }
            }
        });
    }, 100);
}

function addSequenceStep() {
    // Load available templates (demo data)
    const templates = [
        {id: 1, name: 'Welcome Email', subject: 'Welcome to our service!'},
        {id: 2, name: 'Follow-up', subject: 'How are you enjoying our service?'},
        {id: 3, name: 'Special Offer', subject: 'Exclusive offer just for you!'}
    ];
    
    const select = document.getElementById('stepTemplate');
    select.innerHTML = '<option value="">Select template...</option>';
    templates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = `${template.name} - ${template.subject}`;
        select.appendChild(option);
    });
    
    const modal = new bootstrap.Modal(document.getElementById('stepModal'));
    modal.show();
}

function renderSequenceBuilder() {
    const builder = document.getElementById('sequenceBuilder');
    
    if (sequenceSteps.length === 0) {
        builder.innerHTML = `
            <i class="fas fa-plus-circle fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Build Your Email Sequence</h5>
            <p class="text-muted">Add email steps to create an automated sequence</p>
        `;
        return;
    }
    
    let html = '';
    sequenceSteps.forEach((step, index) => {
        html += `
            <div class="step-builder-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="fw-bold">Step ${index + 1}: ${step.templateName}</h6>
                        <p class="text-muted mb-0">${step.templateSubject}</p>
                        ${step.delayDays > 0 || step.delayHours > 0 ? `
                            <div class="step-delay">
                                <i class="fas fa-clock"></i>
                                Wait: ${step.delayDays} days, ${step.delayHours} hours
                            </div>
                        ` : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        
        if (index < sequenceSteps.length - 1) {
            html += '<div class="connector"><i class="fas fa-arrow-down"></i></div>';
        }
    });
    
    builder.innerHTML = html;
}

function removeStep(index) {
    sequenceSteps.splice(index, 1);
    renderSequenceBuilder();
}

function previewSequence() {
    alert('Sequence preview functionality would be implemented here.');
}

// Handle step form submission
document.getElementById('stepForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const templateId = document.getElementById('stepTemplate').value;
    const templateOption = document.getElementById('stepTemplate').selectedOptions[0];
    const templateText = templateOption.textContent;
    const [templateName, templateSubject] = templateText.split(' - ');
    
    const step = {
        templateId: templateId,
        templateName: templateName,
        templateSubject: templateSubject,
        delayDays: parseInt(document.getElementById('stepDelayDays').value) || 0,
        delayHours: parseInt(document.getElementById('stepDelayHours').value) || 0
    };
    
    sequenceSteps.push(step);
    renderSequenceBuilder();
    
    bootstrap.Modal.getInstance(document.getElementById('stepModal')).hide();
    document.getElementById('stepForm').reset();
});

// Handle sequence form submission
document.getElementById('sequenceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('sequenceName').value,
        description: document.getElementById('sequenceDescription').value,
        trigger_type: document.getElementById('sequenceTrigger').value,
        is_active: document.getElementById('sequenceActive').checked,
        steps: sequenceSteps
    };
    
    console.log('Sequence data:', formData);
    alert('Sequence saved successfully!');
    
    bootstrap.Modal.getInstance(document.getElementById('sequenceModal')).hide();
    setTimeout(() => location.reload(), 500);
});
</script>
{% endblock %}